"use strict";
/*
 * MIT License
 *
 * Copyright (c) 2020 RÃ©mi Van Keisbelck
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.subscriptions = exports.update = exports.open = void 0;
const Msg_1 = require("./Msg");
const react_tea_cup_1 = require("react-tea-cup");
const Model_1 = require("./Model");
const Menu_1 = require("./Menu");
const common_1 = require("../common");
function open(menu, refBox, selectFirst = false) {
    return [
        Model_1.initialModel(selectFirst ? menu.selectFirstItem() : menu.deselectAll(), refBox),
        react_tea_cup_1.Cmd.batch([
            react_tea_cup_1.Task.perform(getWindowDimensions, (d) => Msg_1.gotWindowDimensions(d)),
            react_tea_cup_1.Task.perform(react_tea_cup_1.uuid(), (u) => Msg_1.gotUuid(u)),
        ]),
    ];
}
exports.open = open;
function postOpen(model) {
    if (model.uuid.type === 'Nothing') {
        return react_tea_cup_1.noCmd(model);
    }
    if (model.windowSize.type === 'Nothing') {
        return react_tea_cup_1.noCmd(model);
    }
    const cmd = react_tea_cup_1.Task.attempt(Menu_1.menuTask(model.uuid.value).map((e) => common_1.Box.fromDomRect(e.getBoundingClientRect())), (x) => Msg_1.gotMenuBox(x));
    return [model, cmd];
}
function withOut(mac, outMsg = react_tea_cup_1.nothing) {
    return [mac[0], mac[1], outMsg];
}
function update(msg, model) {
    switch (msg.tag) {
        case 'got-window-dimensions': {
            return withOut(postOpen(Object.assign(Object.assign({}, model), { windowSize: react_tea_cup_1.just(msg.d) })));
        }
        case 'got-uuid': {
            return withOut(postOpen(Object.assign(Object.assign({}, model), { uuid: react_tea_cup_1.just(msg.uuid) })));
        }
        case 'got-menu-box': {
            if (model.state.tag === 'placing') {
                const state = model.state;
                return withOut(react_tea_cup_1.noCmd(model.windowSize
                    .map((windowSize) => {
                    const newModel = msg.r.match((menuBox) => (Object.assign(Object.assign({}, model), { state: {
                            tag: 'open',
                            box: common_1.place(windowSize, state.refBox, menuBox.d),
                        } })), (err) => (Object.assign(Object.assign({}, model), { error: react_tea_cup_1.just(err) })));
                    return newModel;
                })
                    .withDefault(model)));
            }
            return withOut(react_tea_cup_1.noCmd(model));
        }
        case 'key-down': {
            switch (msg.key) {
                case 'Escape': {
                    return withOut(collapseLastSubMenu(Model_1.keyboardNavigated(model)), model.child.isNothing() ? react_tea_cup_1.just({ tag: 'request-close' }) : react_tea_cup_1.nothing);
                }
                case 'ArrowDown':
                case 'ArrowUp': {
                    return mapLastMenu(Model_1.keyboardNavigated(model), (lastModel) => {
                        return withOut(react_tea_cup_1.noCmd(Object.assign(Object.assign({}, lastModel), { menu: lastModel.menu.moveSelection(msg.key === 'ArrowDown') })));
                    });
                }
                case 'ArrowLeft':
                    return withOut(collapseLastSubMenu(Model_1.keyboardNavigated(model)));
                case 'ArrowRight':
                    return expandLastSubMenu(Model_1.keyboardNavigated(model));
                case 'Enter':
                case ' ': {
                    return toggleOrSelectItem(model);
                }
                default:
                    return withOut(react_tea_cup_1.noCmd(model));
            }
        }
        case 'mouse-move': {
            if (model.menu.isSelected(msg.item)) {
                return withOut(react_tea_cup_1.noCmd(model));
            }
            const newModel = Object.assign(Object.assign({}, model), { subMenuCounter: model.subMenuCounter + 1 });
            if (model.navigatedWithKeyboard) {
                return withOut(react_tea_cup_1.noCmd(Model_1.keyboardNavigated(newModel, false)));
            }
            if (model.uuid.type === 'Nothing') {
                return withOut(react_tea_cup_1.noCmd(newModel));
            }
            const menu = model.menu.selectItem(msg.item);
            const uuid = model.uuid.value;
            return withOut(openSubMenu(Object.assign(Object.assign({}, newModel), { menu, child: react_tea_cup_1.nothing }), uuid, msg.item, msg.itemIndex, false));
        }
        case 'mouse-leave': {
            return withOut(react_tea_cup_1.noCmd(model.child.isJust()
                ? model
                : Object.assign(Object.assign({}, model), { menu: model.menu.deselectAll() })));
        }
        case 'got-item-box': {
            if (msg.subMenuCounter !== model.subMenuCounter) {
                return withOut(react_tea_cup_1.noCmd(model));
            }
            return withOut(msg.r.match((itemBox) => {
                const newModel = Object.assign(Object.assign({}, model), { menu: model.menu.selectItem(msg.item) });
                return msg.item.subMenu
                    .map((subMenu) => {
                    // we have a sub menu so we need
                    // to open a new Menu !
                    const mac = open(subMenu, itemBox, msg.selectFirst);
                    const newModel2 = Object.assign(Object.assign({}, newModel), { child: react_tea_cup_1.just(mac[0]) });
                    return react_tea_cup_1.Tuple.t2n(newModel2, mac[1].map(Msg_1.childMsg));
                })
                    .withDefaultSupply(() => {
                    // close any existing child !
                    return newModel.child
                        .map(() => react_tea_cup_1.noCmd(Object.assign(Object.assign({}, model), { child: react_tea_cup_1.nothing })))
                        .withDefaultSupply(() => react_tea_cup_1.noCmd(model));
                });
            }, (err) => react_tea_cup_1.noCmd(Object.assign(Object.assign({}, model), { error: react_tea_cup_1.just(err) }))));
        }
        case 'child-msg': {
            return model.child
                .map((child) => {
                const mco = update(msg.m, child);
                const newModel = Object.assign(Object.assign({}, model), { child: react_tea_cup_1.just(mco[0]) });
                return withOut(react_tea_cup_1.Tuple.t2n(newModel, mco[1].map(Msg_1.childMsg)), mco[2]);
            })
                .withDefaultSupply(() => withOut(react_tea_cup_1.noCmd(model)));
        }
        case 'item-clicked': {
            return withOut(react_tea_cup_1.noCmd(model), outItemSelected(msg.item));
        }
        case 'doc-mouse-down': {
            return withOut(react_tea_cup_1.noCmd(model), react_tea_cup_1.just({ tag: 'request-close' }));
        }
        case 'noop': {
            return withOut(react_tea_cup_1.noCmd(model));
        }
    }
}
exports.update = update;
function outItemSelected(item) {
    return react_tea_cup_1.just({ tag: 'item-selected', data: item.userData });
}
function openSubMenu(model, menuId, item, itemIndex, selectFirst) {
    if (item.subMenu.isNothing()) {
        return react_tea_cup_1.noCmd(model);
    }
    const subMenuCounter = model.subMenuCounter + 1;
    return react_tea_cup_1.Tuple.t2n(Object.assign(Object.assign({}, model), { subMenuCounter }), react_tea_cup_1.Task.attempt(Menu_1.menuItemTask(menuId, itemIndex).map((e) => {
        return common_1.Box.fromDomRect(e.getBoundingClientRect());
    }), (r) => Msg_1.gotItemBox(item, r, subMenuCounter, selectFirst)));
}
const windowEvents = new react_tea_cup_1.WindowEvents();
const documentEvents = new react_tea_cup_1.DocumentEvents();
function subscriptions(model) {
    return react_tea_cup_1.Sub.batch([
        windowEvents.on('resize', () => Msg_1.gotWindowDimensions(common_1.dim(window.innerWidth, window.innerHeight))),
        documentEvents.on('mousedown', (evt) => {
            if (evt.button === 2) {
                return Msg_1.noop();
            }
            let t = evt.target;
            while (t) {
                // move up and try to find if we are inside a tea-pop Menu !
                if (t.classList.contains('tm')) {
                    return Msg_1.noop();
                }
                t = t.parentElement;
            }
            return Msg_1.docMouseDown();
        }),
        model.state.tag === 'open'
            ? documentEvents.on('keydown', (e) => Msg_1.gotKeyDown(e.key))
            : react_tea_cup_1.Sub.none(),
    ]);
}
exports.subscriptions = subscriptions;
const getWindowDimensions = react_tea_cup_1.Task.succeedLazy(() => common_1.dim(window.innerWidth, window.innerHeight));
function mapLastMenu(model, f) {
    switch (model.child.type) {
        case 'Nothing': {
            // I'm the last model !
            return f(model);
        }
        case 'Just': {
            const mac = mapLastMenu(model.child.value, f);
            return [Object.assign(Object.assign({}, model), { child: react_tea_cup_1.just(mac[0]) }), mac[1].map(Msg_1.childMsg), mac[2]];
        }
    }
}
function collapseLastSubMenu(model) {
    switch (model.child.type) {
        case 'Nothing':
            return react_tea_cup_1.noCmd(model);
        case 'Just': {
            // I have a child : close it if he has no child !
            const child = model.child.value;
            if (child.child.isJust()) {
                return react_tea_cup_1.Tuple.fromNative(collapseLastSubMenu(child))
                    .mapFirst((c) => (Object.assign(Object.assign({}, model), { child: react_tea_cup_1.just(c) })))
                    .mapSecond((cmd) => cmd.map(Msg_1.childMsg))
                    .toNative();
            }
            else {
                return react_tea_cup_1.noCmd(Object.assign(Object.assign({}, model), { child: react_tea_cup_1.nothing }));
            }
        }
    }
}
function expandLastSubMenu(model) {
    return mapLastMenu(model, (lastModel) => {
        return lastModel.menu.selectedItem
            .map((selectedItem) => {
            return selectedItem.subMenu
                .map(() => {
                if (lastModel.uuid.type === 'Nothing') {
                    return withOut(react_tea_cup_1.noCmd(lastModel));
                }
                const uuid = lastModel.uuid.value;
                const mac = lastModel.menu
                    .indexOfItem(selectedItem)
                    .map((itemIndex) => {
                    return openSubMenu(lastModel, uuid, selectedItem, itemIndex, true);
                })
                    .withDefaultSupply(() => react_tea_cup_1.noCmd(lastModel));
                return withOut(mac);
            })
                .withDefaultSupply(() => {
                return withOut(react_tea_cup_1.noCmd(lastModel));
            });
        })
            .withDefaultSupply(() => {
            return withOut(react_tea_cup_1.noCmd(lastModel));
        });
    });
}
function toggleOrSelectItem(model) {
    return mapLastMenu(model, (lastModel) => {
        return lastModel.menu.selectedItem
            .map((selectedItem) => {
            if (lastModel.uuid.type === 'Nothing') {
                return withOut(react_tea_cup_1.noCmd(lastModel));
            }
            const uuid = lastModel.uuid.value;
            // do we have a sub-menu ?
            return selectedItem.subMenu
                .map(() => {
                // we have a sub-menu, expand it
                const mac = lastModel.menu
                    .indexOfItem(selectedItem)
                    .map((itemIndex) => openSubMenu(lastModel, uuid, selectedItem, itemIndex, true))
                    .withDefaultSupply(() => react_tea_cup_1.noCmd(lastModel));
                return withOut(mac);
            })
                .withDefaultSupply(() => {
                // no sub-menu, select the item
                return withOut(react_tea_cup_1.noCmd(lastModel), outItemSelected(selectedItem));
            });
        })
            .withDefaultSupply(() => withOut(react_tea_cup_1.noCmd(lastModel)));
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVhUG9wLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21lbnUvVGVhUG9wLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7OztBQUVILCtCQVVlO0FBQ2YsaURBWXVCO0FBQ3ZCLG1DQUFpRTtBQUNqRSxpQ0FBZ0U7QUFDaEUsc0NBQWlEO0FBR2pELFNBQWdCLElBQUksQ0FDbEIsSUFBYSxFQUNiLE1BQVcsRUFDWCxXQUFXLEdBQUcsS0FBSztJQUVuQixPQUFPO1FBQ0wsb0JBQVksQ0FDVixXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUN6RCxNQUFNLENBQ1A7UUFDRCxtQkFBRyxDQUFDLEtBQUssQ0FBQztZQUNSLG9CQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyx5QkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRSxvQkFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QyxDQUFDO0tBQ0gsQ0FBQztBQUNKLENBQUM7QUFmRCxvQkFlQztBQUVELFNBQVMsUUFBUSxDQUFJLEtBQWU7SUFDbEMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7UUFDakMsT0FBTyxxQkFBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3JCO0lBQ0QsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7UUFDdkMsT0FBTyxxQkFBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3JCO0lBQ0QsTUFBTSxHQUFHLEdBQWdCLG9CQUFJLENBQUMsT0FBTyxDQUNuQyxlQUFRLENBQUMs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QUFDLE9BQU87aUJBQ3hCLEdBQUcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ1IsZ0NBQWdDO2dCQUNoQyxNQUFNLEdBQUcsR0FBNEIsU0FBUyxDQUFDLElBQUk7cUJBQ2hELFdBQVcsQ0FBQyxZQUFZLENBQUM7cUJBQ3pCLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQ2pCLFdBQVcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQzVEO3FCQUNBLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxDQUFDLHFCQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDN0MsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDO2lCQUNELGlCQUFpQixDQUFDLEdBQUcsRUFBRTtnQkFDdEIsK0JBQStCO2dCQUMvQixPQUFPLE9BQU8sQ0FBQyxxQkFBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDO2FBQ0QsaUJBQWlCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLHFCQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNSVQgTGljZW5zZVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAyMCBSw6ltaSBWYW4gS2Vpc2JlbGNrXG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqXG4gKi9cblxuaW1wb3J0IHtcbiAgY2hpbGRNc2csXG4gIGRvY01vdXNlRG93bixcbiAgZ290SXRlbUJveCxcbiAgZ290S2V5RG93bixcbiAgZ290TWVudUJveCxcbiAgZ290VXVpZCxcbiAgZ290V2luZG93RGltZW5zaW9ucyxcbiAgTXNnLFxuICBub29wLFxufSBmcm9tICcuL01zZyc7XG5pbXBvcnQge1xuICBDbWQsXG4gIERvY3VtZW50RXZlbnRzLFxuICBqdXN0LFxuICBNYXliZSxcbiAgbm9DbWQsXG4gIG5vdGhpbmcsXG4gIFN1YixcbiAgVGFzayxcbiAgVHVwbGUsXG4gIHV1aWQsXG4gIFdpbmRvd0V2ZW50cyxcbn0gZnJvbSAncmVhY3QtdGVhLWN1cCc7XG5pbXBvcnQgeyBpbml0aWFsTW9kZWwsIGtleWJvYXJkTmF2aWdhdGVkLCBNb2RlbCB9IGZyb20gJy4vTW9kZWwnO1xuaW1wb3J0IHsgTWVudSwgTWVudUl0ZW0sIG1lbnVJdGVtVGFzaywgbWVudVRhc2sgfSBmcm9tICcuL01lbnUnO1xuaW1wb3J0IHsgZGltLCBEaW0sIEJveCwgcGxhY2UgfSBmcm9tICcuLi9jb21tb24nO1xuaW1wb3J0IHsgT3V0TXNnIH0gZnJvbSAnLi9PdXRNc2cnO1xuXG5leHBvcnQgZnVuY3Rpb24gb3BlbjxUPihcbiAgbWVudTogTWVudTxUPixcbiAgcmVmQm94OiBCb3gsXG4gIHNlbGVjdEZpcnN0ID0gZmFsc2UsXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+XSB7XG4gIHJldHVybiBbXG4gICAgaW5pdGlhbE1vZGVsKFxuICAgICAgc2VsZWN0Rmlyc3QgPyBtZW51LnNlbGVjdEZpcnN0SXRlbSgpIDogbWVudS5kZXNlbGVjdEFsbCgpLFxuICAgICAgcmVmQm94LFxuICAgICksXG4gICAgQ21kLmJhdGNoKFtcbiAgICAgIFRhc2sucGVyZm9ybShnZXRXaW5kb3dEaW1lbnNpb25zLCAoZCkgPT4gZ290V2luZG93RGltZW5zaW9ucyhkKSksXG4gICAgICBUYXNrLnBlcmZvcm0odXVpZCgpLCAodSkgPT4gZ290VXVpZCh1KSksXG4gICAgXSksXG4gIF07XG59XG5cbmZ1bmN0aW9uIHBvc3RPcGVuPFQ+KG1vZGVsOiBNb2RlbDxUPik6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dIHtcbiAgaWYgKG1vZGVsLnV1aWQudHlwZSA9PT0gJ05vdGhpbmcnKSB7XG4gICAgcmV0dXJuIG5vQ21kKG1vZGVsKTtcbiAgfVxuICBpZiAobW9kZWwud2luZG93U2l6ZS50eXBlID09PSAnTm90aGluZycpIHtcbiAgICByZXR1cm4gbm9DbWQobW9kZWwpO1xuICB9XG4gIGNvbnN0IGNtZDogQ21kPE1zZzxUPj4gPSBUYXNrLmF0dGVtcHQoXG4gICAgbWVudVRhc2sobW9kZWwudXVpZC52YWx1ZSkubWFwKChlKSA9PlxuICAgICAgQm94LmZyb21Eb21SZWN0KGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpLFxuICAgICksXG4gICAgKHgpID0+IGdvdE1lbnVCb3goeCksXG4gICk7XG4gIHJldHVybiBbbW9kZWwsIGNtZF07XG59XG5cbmZ1bmN0aW9uIHdpdGhPdXQ8VD4oXG4gIG1hYzogW01vZGVsPFQ+LCBDbWQ8TXNnPFQ+Pl0sXG4gIG91dE1zZzogTWF5YmU8T3V0TXNnPFQ+PiA9IG5vdGhpbmcsXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBbbWFjWzBdLCBtYWNbMV0sIG91dE1zZ107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGU8VD4oXG4gIG1zZzogTXNnPFQ+LFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHN3aXRjaCAobXNnLnRhZykge1xuICAgIGNhc2UgJ2dvdC13aW5kb3ctZGltZW5zaW9ucyc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KFxuICAgICAgICBwb3N0T3Blbih7XG4gICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgd2luZG93U2l6ZToganVzdChtc2cuZCksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnZ290LXV1aWQnOiB7XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgcG9zdE9wZW4oe1xuICAgICAgICAgIC4uLm1vZGVsLFxuICAgICAgICAgIHV1aWQ6IGp1c3QobXNnLnV1aWQpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ2dvdC1tZW51LWJveCc6IHtcbiAgICAgIGlmIChtb2RlbC5zdGF0ZS50YWcgPT09ICdwbGFjaW5nJykge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IG1vZGVsLnN0YXRlO1xuICAgICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgICBub0NtZChcbiAgICAgICAgICAgIG1vZGVsLndpbmRvd1NpemVcbiAgICAgICAgICAgICAgLm1hcCgod2luZG93U2l6ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld01vZGVsOiBNb2RlbDxUPiA9IG1zZy5yLm1hdGNoKFxuICAgICAgICAgICAgICAgICAgKG1lbnVCb3gpID0+XG4gICAgICAgICAgICAgICAgICAgICh7XG4gICAgICAgICAgICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZzogJ29wZW4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm94OiBwbGFjZSh3aW5kb3dTaXplLCBzdGF0ZS5yZWZCb3gsIG1lbnVCb3guZCksXG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSBhcyBNb2RlbDxUPiksXG4gICAgICAgICAgICAgICAgICAoZXJyKSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICAuLi5tb2RlbCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGp1c3QoZXJyKSxcbiAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld01vZGVsO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAud2l0aERlZmF1bHQobW9kZWwpLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCkpO1xuICAgIH1cblxuICAgIGNhc2UgJ2tleS1kb3duJzoge1xuICAgICAgc3dpdGNoIChtc2cua2V5KSB7XG4gICAgICAgIGNhc2UgJ0VzY2FwZSc6IHtcbiAgICAgICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgICAgIGNvbGxhcHNlTGFzdFN1Yk1lbnUoa2V5Ym9hcmROYXZpZ2F0ZWQobW9kZWwpKSxcbiAgICAgICAgICAgIG1vZGVsLmNoaWxkLmlzTm90aGluZygpID8ganVzdCh7IHRhZzogJ3JlcXVlc3QtY2xvc2UnIH0pIDogbm90aGluZyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgJ0Fycm93RG93bic6XG4gICAgICAgIGNhc2UgJ0Fycm93VXAnOiB7XG4gICAgICAgICAgcmV0dXJuIG1hcExhc3RNZW51KGtleWJvYXJkTmF2aWdhdGVkKG1vZGVsKSwgKGxhc3RNb2RlbCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQoXG4gICAgICAgICAgICAgIG5vQ21kKHtcbiAgICAgICAgICAgICAgICAuLi5sYXN0TW9kZWwsXG4gICAgICAgICAgICAgICAgbWVudTogbGFzdE1vZGVsLm1lbnUubW92ZVNlbGVjdGlvbihtc2cua2V5ID09PSAnQXJyb3dEb3duJyksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXNlICdBcnJvd0xlZnQnOlxuICAgICAgICAgIHJldHVybiB3aXRoT3V0KGNvbGxhcHNlTGFzdFN1Yk1lbnUoa2V5Ym9hcmROYXZpZ2F0ZWQobW9kZWwpKSk7XG4gICAgICAgIGNhc2UgJ0Fycm93UmlnaHQnOlxuICAgICAgICAgIHJldHVybiBleHBhbmRMYXN0U3ViTWVudShrZXlib2FyZE5hdmlnYXRlZChtb2RlbCkpO1xuICAgICAgICBjYXNlICdFbnRlcic6XG4gICAgICAgIGNhc2UgJyAnOiB7XG4gICAgICAgICAgcmV0dXJuIHRvZ2dsZU9yU2VsZWN0SXRlbShtb2RlbCk7XG4gICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCkpO1xuICAgICAgfVxuICAgIH1cbiAgICBjYXNlICdtb3VzZS1tb3ZlJzoge1xuICAgICAgaWYgKG1vZGVsLm1lbnUuaXNTZWxlY3RlZChtc2cuaXRlbSkpIHtcbiAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobW9kZWwpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5ld01vZGVsID0geyAuLi5tb2RlbCwgc3ViTWVudUNvdW50ZXI6IG1vZGVsLnN1Yk1lbnVDb3VudGVyICsgMSB9O1xuICAgICAgaWYgKG1vZGVsLm5hdmlnYXRlZFdpdGhLZXlib2FyZCkge1xuICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChrZXlib2FyZE5hdmlnYXRlZChuZXdNb2RlbCwgZmFsc2UpKSk7XG4gICAgICB9XG4gICAgICBpZiAobW9kZWwudXVpZC50eXBlID09PSAnTm90aGluZycpIHtcbiAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobmV3TW9kZWwpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1lbnUgPSBtb2RlbC5tZW51LnNlbGVjdEl0ZW0obXNnLml0ZW0pO1xuICAgICAgY29uc3QgdXVpZCA9IG1vZGVsLnV1aWQudmFsdWU7XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgb3BlblN1Yk1lbnUoXG4gICAgICAgICAgeyAuLi5uZXdNb2RlbCwgbWVudSwgY2hpbGQ6IG5vdGhpbmcgfSxcbiAgICAgICAgICB1dWlkLFxuICAgICAgICAgIG1zZy5pdGVtLFxuICAgICAgICAgIG1zZy5pdGVtSW5kZXgsXG4gICAgICAgICAgZmFsc2UsXG4gICAgICAgICksXG4gICAgICApO1xuICAgIH1cbiAgICBjYXNlICdtb3VzZS1sZWF2ZSc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KFxuICAgICAgICBub0NtZChcbiAgICAgICAgICBtb2RlbC5jaGlsZC5pc0p1c3QoKVxuICAgICAgICAgICAgPyBtb2RlbFxuICAgICAgICAgICAgOiB7IC4uLm1vZGVsLCBtZW51OiBtb2RlbC5tZW51LmRlc2VsZWN0QWxsKCkgfSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfVxuICAgIGNhc2UgJ2dvdC1pdGVtLWJveCc6IHtcbiAgICAgIGlmIChtc2cuc3ViTWVudUNvdW50ZXIgIT09IG1vZGVsLnN1Yk1lbnVDb3VudGVyKSB7XG4gICAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aE91dChcbiAgICAgICAgbXNnLnIubWF0Y2goXG4gICAgICAgICAgKGl0ZW1Cb3gpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5ld01vZGVsOiBNb2RlbDxUPiA9IHtcbiAgICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICAgIG1lbnU6IG1vZGVsLm1lbnUuc2VsZWN0SXRlbShtc2cuaXRlbSksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIG1zZy5pdGVtLnN1Yk1lbnVcbiAgICAgICAgICAgICAgLm1hcCgoc3ViTWVudSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHdlIGhhdmUgYSBzdWIgbWVudSBzbyB3ZSBuZWVkXG4gICAgICAgICAgICAgICAgLy8gdG8gb3BlbiBhIG5ldyBNZW51ICFcbiAgICAgICAgICAgICAgICBjb25zdCBtYWMgPSBvcGVuKHN1Yk1lbnUsIGl0ZW1Cb3gsIG1zZy5zZWxlY3RGaXJzdCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3TW9kZWwyOiBNb2RlbDxUPiA9IHtcbiAgICAgICAgICAgICAgICAgIC4uLm5ld01vZGVsLFxuICAgICAgICAgICAgICAgICAgY2hpbGQ6IGp1c3QobWFjWzBdKSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiBUdXBsZS50Mm4obmV3TW9kZWwyLCBtYWNbMV0ubWFwKGNoaWxkTXNnKSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gY2xvc2UgYW55IGV4aXN0aW5nIGNoaWxkICFcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3TW9kZWwuY2hpbGRcbiAgICAgICAgICAgICAgICAgIC5tYXAoKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgbm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4oeyAuLi5tb2RlbCwgY2hpbGQ6IG5vdGhpbmcgfSksXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4gbm9DbWQobW9kZWwpKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoZXJyKSA9PiBub0NtZCh7IC4uLm1vZGVsLCBlcnJvcjoganVzdChlcnIpIH0pLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9XG4gICAgY2FzZSAnY2hpbGQtbXNnJzoge1xuICAgICAgcmV0dXJuIG1vZGVsLmNoaWxkXG4gICAgICAgIC5tYXAoKGNoaWxkKSA9PiB7XG4gICAgICAgICAgY29uc3QgbWNvID0gdXBkYXRlKG1zZy5tLCBjaGlsZCk7XG4gICAgICAgICAgY29uc3QgbmV3TW9kZWw6IE1vZGVsPFQ+ID0ge1xuICAgICAgICAgICAgLi4ubW9kZWwsXG4gICAgICAgICAgICBjaGlsZDoganVzdChtY29bMF0pLFxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIHdpdGhPdXQoVHVwbGUudDJuKG5ld01vZGVsLCBtY29bMV0ubWFwKGNoaWxkTXNnKSksIG1jb1syXSk7XG4gICAgICAgIH0pXG4gICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB3aXRoT3V0KG5vQ21kKG1vZGVsKSkpO1xuICAgIH1cbiAgICBjYXNlICdpdGVtLWNsaWNrZWQnOiB7XG4gICAgICByZXR1cm4gd2l0aE91dChub0NtZChtb2RlbCksIG91dEl0ZW1TZWxlY3RlZChtc2cuaXRlbSkpO1xuICAgIH1cbiAgICBjYXNlICdkb2MtbW91c2UtZG93bic6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSwganVzdCh7IHRhZzogJ3JlcXVlc3QtY2xvc2UnIH0pKTtcbiAgICB9XG4gICAgY2FzZSAnbm9vcCc6IHtcbiAgICAgIHJldHVybiB3aXRoT3V0KG5vQ21kKG1vZGVsKSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG91dEl0ZW1TZWxlY3RlZDxUPihpdGVtOiBNZW51SXRlbTxUPik6IE1heWJlPE91dE1zZzxUPj4ge1xuICByZXR1cm4ganVzdCh7IHRhZzogJ2l0ZW0tc2VsZWN0ZWQnLCBkYXRhOiBpdGVtLnVzZXJEYXRhIH0pO1xufVxuXG5mdW5jdGlvbiBvcGVuU3ViTWVudTxUPihcbiAgbW9kZWw6IE1vZGVsPFQ+LFxuICBtZW51SWQ6IHN0cmluZyxcbiAgaXRlbTogTWVudUl0ZW08VD4sXG4gIGl0ZW1JbmRleDogbnVtYmVyLFxuICBzZWxlY3RGaXJzdDogYm9vbGVhbixcbik6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dIHtcbiAgaWYgKGl0ZW0uc3ViTWVudS5pc05vdGhpbmcoKSkge1xuICAgIHJldHVybiBub0NtZChtb2RlbCk7XG4gIH1cbiAgY29uc3Qgc3ViTWVudUNvdW50ZXIgPSBtb2RlbC5zdWJNZW51Q291bnRlciArIDE7XG4gIHJldHVybiBUdXBsZS50Mm4oXG4gICAgeyAuLi5tb2RlbCwgc3ViTWVudUNvdW50ZXIgfSxcbiAgICBUYXNrLmF0dGVtcHQoXG4gICAgICBtZW51SXRlbVRhc2sobWVudUlkLCBpdGVtSW5kZXgpLm1hcCgoZSkgPT4ge1xuICAgICAgICByZXR1cm4gQm94LmZyb21Eb21SZWN0KGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpO1xuICAgICAgfSksXG4gICAgICAocikgPT4gZ290SXRlbUJveChpdGVtLCByLCBzdWJNZW51Q291bnRlciwgc2VsZWN0Rmlyc3QpLFxuICAgICksXG4gICk7XG59XG5cbmNvbnN0IHdpbmRvd0V2ZW50cyA9IG5ldyBXaW5kb3dFdmVudHMoKTtcbmNvbnN0IGRvY3VtZW50RXZlbnRzID0gbmV3IERvY3VtZW50RXZlbnRzKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzdWJzY3JpcHRpb25zPFQ+KG1vZGVsOiBNb2RlbDxUPik6IFN1YjxNc2c8VD4+IHtcbiAgcmV0dXJuIFN1Yi5iYXRjaChbXG4gICAgd2luZG93RXZlbnRzLm9uKCdyZXNpemUnLCAoKSA9PlxuICAgICAgZ290V2luZG93RGltZW5zaW9ucyhkaW0od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCkpLFxuICAgICksXG4gICAgZG9jdW1lbnRFdmVudHMub24oJ21vdXNlZG93bicsIChldnQpID0+IHtcbiAgICAgIGlmIChldnQuYnV0dG9uID09PSAyKSB7XG4gICAgICAgIHJldHVybiBub29wKCk7XG4gICAgICB9XG4gICAgICBsZXQgdDogSFRNTEVsZW1lbnQgfCBudWxsID0gZXZ0LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIHdoaWxlICh0KSB7XG4gICAgICAgIC8vIG1vdmUgdXAgYW5kIHRyeSB0byBmaW5kIGlmIHdlIGFyZSBpbnNpZGUgYSB0ZWEtcG9wIE1lbnUgIVxuICAgICAgICBpZiAodC5jbGFzc0xpc3QuY29udGFpbnMoJ3RtJykpIHtcbiAgICAgICAgICByZXR1cm4gbm9vcCgpO1xuICAgICAgICB9XG4gICAgICAgIHQgPSB0LnBhcmVudEVsZW1lbnQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gZG9jTW91c2VEb3duKCk7XG4gICAgfSksXG4gICAgbW9kZWwuc3RhdGUudGFnID09PSAnb3BlbidcbiAgICAgID8gZG9jdW1lbnRFdmVudHMub24oJ2tleWRvd24nLCAoZSkgPT4gZ290S2V5RG93bihlLmtleSkpXG4gICAgICA6IFN1Yi5ub25lKCksXG4gIF0pO1xufVxuXG5jb25zdCBnZXRXaW5kb3dEaW1lbnNpb25zOiBUYXNrPG5ldmVyLCBEaW0+ID0gVGFzay5zdWNjZWVkTGF6eSgoKSA9PlxuICBkaW0od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCksXG4pO1xuXG5mdW5jdGlvbiBtYXBMYXN0TWVudTxUPihcbiAgbW9kZWw6IE1vZGVsPFQ+LFxuICBmOiAobTogTW9kZWw8VD4pID0+IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj4sIE1heWJlPE91dE1zZzxUPj5dLFxuKTogW01vZGVsPFQ+LCBDbWQ8TXNnPFQ+PiwgTWF5YmU8T3V0TXNnPFQ+Pl0ge1xuICBzd2l0Y2ggKG1vZGVsLmNoaWxkLnR5cGUpIHtcbiAgICBjYXNlICdOb3RoaW5nJzoge1xuICAgICAgLy8gSSdtIHRoZSBsYXN0IG1vZGVsICFcbiAgICAgIHJldHVybiBmKG1vZGVsKTtcbiAgICB9XG4gICAgY2FzZSAnSnVzdCc6IHtcbiAgICAgIGNvbnN0IG1hYyA9IG1hcExhc3RNZW51KG1vZGVsLmNoaWxkLnZhbHVlLCBmKTtcbiAgICAgIHJldHVybiBbeyAuLi5tb2RlbCwgY2hpbGQ6IGp1c3QobWFjWzBdKSB9LCBtYWNbMV0ubWFwKGNoaWxkTXNnKSwgbWFjWzJdXTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY29sbGFwc2VMYXN0U3ViTWVudTxUPihtb2RlbDogTW9kZWw8VD4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+XSB7XG4gIHN3aXRjaCAobW9kZWwuY2hpbGQudHlwZSkge1xuICAgIGNhc2UgJ05vdGhpbmcnOlxuICAgICAgcmV0dXJuIG5vQ21kKG1vZGVsKTtcbiAgICBjYXNlICdKdXN0Jzoge1xuICAgICAgLy8gSSBoYXZlIGEgY2hpbGQgOiBjbG9zZSBpdCBpZiBoZSBoYXMgbm8gY2hpbGQgIVxuICAgICAgY29uc3QgY2hpbGQgPSBtb2RlbC5jaGlsZC52YWx1ZTtcbiAgICAgIGlmIChjaGlsZC5jaGlsZC5pc0p1c3QoKSkge1xuICAgICAgICByZXR1cm4gVHVwbGUuZnJvbU5hdGl2ZShjb2xsYXBzZUxhc3RTdWJNZW51KGNoaWxkKSlcbiAgICAgICAgICAubWFwRmlyc3QoKGMpID0+ICh7IC4uLm1vZGVsLCBjaGlsZDoganVzdChjKSB9KSlcbiAgICAgICAgICAubWFwU2Vjb25kKChjbWQpID0+IGNtZC5tYXAoY2hpbGRNc2cpKVxuICAgICAgICAgIC50b05hdGl2ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5vQ21kKHtcbiAgICAgICAgICAuLi5tb2RlbCxcbiAgICAgICAgICBjaGlsZDogbm90aGluZyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGV4cGFuZExhc3RTdWJNZW51PFQ+KFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBtYXBMYXN0TWVudShtb2RlbCwgKGxhc3RNb2RlbCkgPT4ge1xuICAgIHJldHVybiBsYXN0TW9kZWwubWVudS5zZWxlY3RlZEl0ZW1cbiAgICAgIC5tYXAoKHNlbGVjdGVkSXRlbSkgPT4ge1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWRJdGVtLnN1Yk1lbnVcbiAgICAgICAgICAubWFwKCgpID0+IHtcbiAgICAgICAgICAgIGlmIChsYXN0TW9kZWwudXVpZC50eXBlID09PSAnTm90aGluZycpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4obGFzdE1vZGVsKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCB1dWlkID0gbGFzdE1vZGVsLnV1aWQudmFsdWU7XG4gICAgICAgICAgICBjb25zdCBtYWM6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dID0gbGFzdE1vZGVsLm1lbnVcbiAgICAgICAgICAgICAgLmluZGV4T2ZJdGVtKHNlbGVjdGVkSXRlbSlcbiAgICAgICAgICAgICAgLm1hcCgoaXRlbUluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wZW5TdWJNZW51KFxuICAgICAgICAgICAgICAgICAgbGFzdE1vZGVsLFxuICAgICAgICAgICAgICAgICAgdXVpZCxcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbSxcbiAgICAgICAgICAgICAgICAgIGl0ZW1JbmRleCxcbiAgICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLndpdGhEZWZhdWx0U3VwcGx5KCgpID0+IG5vQ21kKGxhc3RNb2RlbCkpO1xuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobWFjKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4ge1xuICAgICAgICByZXR1cm4gd2l0aE91dChub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdG9nZ2xlT3JTZWxlY3RJdGVtPFQ+KFxuICBtb2RlbDogTW9kZWw8VD4sXG4pOiBbTW9kZWw8VD4sIENtZDxNc2c8VD4+LCBNYXliZTxPdXRNc2c8VD4+XSB7XG4gIHJldHVybiBtYXBMYXN0TWVudShtb2RlbCwgKGxhc3RNb2RlbCkgPT4ge1xuICAgIHJldHVybiBsYXN0TW9kZWwubWVudS5zZWxlY3RlZEl0ZW1cbiAgICAgIC5tYXAoKHNlbGVjdGVkSXRlbSkgPT4ge1xuICAgICAgICBpZiAobGFzdE1vZGVsLnV1aWQudHlwZSA9PT0gJ05vdGhpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQ8TW9kZWw8VD4sIE1zZzxUPj4obGFzdE1vZGVsKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXVpZCA9IGxhc3RNb2RlbC51dWlkLnZhbHVlO1xuICAgICAgICAvLyBkbyB3ZSBoYXZlIGEgc3ViLW1lbnUgP1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWRJdGVtLnN1Yk1lbnVcbiAgICAgICAgICAubWFwKCgpID0+IHtcbiAgICAgICAgICAgIC8vIHdlIGhhdmUgYSBzdWItbWVudSwgZXhwYW5kIGl0XG4gICAgICAgICAgICBjb25zdCBtYWM6IFtNb2RlbDxUPiwgQ21kPE1zZzxUPj5dID0gbGFzdE1vZGVsLm1lbnVcbiAgICAgICAgICAgICAgLmluZGV4T2ZJdGVtKHNlbGVjdGVkSXRlbSlcbiAgICAgICAgICAgICAgLm1hcCgoaXRlbUluZGV4KSA9PlxuICAgICAgICAgICAgICAgIG9wZW5TdWJNZW51KGxhc3RNb2RlbCwgdXVpZCwgc2VsZWN0ZWRJdGVtLCBpdGVtSW5kZXgsIHRydWUpLFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiBub0NtZChsYXN0TW9kZWwpKTtcbiAgICAgICAgICAgIHJldHVybiB3aXRoT3V0KG1hYyk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2l0aERlZmF1bHRTdXBwbHkoKCkgPT4ge1xuICAgICAgICAgICAgLy8gbm8gc3ViLW1lbnUsIHNlbGVjdCB0aGUgaXRlbVxuICAgICAgICAgICAgcmV0dXJuIHdpdGhPdXQobm9DbWQobGFzdE1vZGVsKSwgb3V0SXRlbVNlbGVjdGVkKHNlbGVjdGVkSXRlbSkpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC53aXRoRGVmYXVsdFN1cHBseSgoKSA9PiB3aXRoT3V0KG5vQ21kKGxhc3RNb2RlbCkpKTtcbiAgfSk7XG59XG4iXX0=